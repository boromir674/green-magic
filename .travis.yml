os: linux
language: python
cache: pip

env:
  global:
    - LD_PRELOAD=/lib/x86_64-linux-gnu/libSegFault.so
    - SEGFAULT_SIGNALS=all
    - TOX_SKIP_MISSING_INTERPRETERS="False"
    - secure: p4\/GxB\+E5BvcMDH0e0zztxDA\/vHBFnyAfjvjMXo6hEqVZ4nsSMHulfk3D05d545aL8bVW8puv9h9eb\/ULyart8tOK\/cP5HrfTMV0zS5CYaSdRjfUNArnHqu\/PuS7\+dwC2jm0pJ6kYCEg6QZkT4NMxhOT984CVWKkYSnJeOePqPQGn3o\/mWESwjpCTit1uyLIcMdyjfTVNWm0aYj5YlBbjwzLwyQebJQpovvU8rRpSAycHFufnDNWEoeuNpazTM017pLZ8Iy9mfB2p8IqONFJFgNdTxBq9DQDAQFcVFtNv7vsICVRswfpDNvGvWzHir7n4xolEfscH8pW3\/4lAGmWeFZR\+LGBnxVxNDJb52kbhri1Fe2b\/5NXM\+NSN5uR0bk9lD7sLJIdI4AV7nv4MTGtbZVuQw\+oIiYMuaO7H9Ayq83VaOAVULynNKlhUWR7t52BqLZxU2MgK9Y4rLzr9ljkBK5lAGjUlZRnHXJU\+N\+fNAVS39i71KbI5pH6t1v05bz6A0Cl4VckystiH1eLYQN5bnJh4eNeQN3\/cJRjPXDE3B55iIEjGmKLinpDVmXQdrf9UK239AYdLztUKty9k7wwTTEoMjxHWCv0AiVBvF\+LhrtScgAAv9MpT4s1zNuFmuZU1VOVJ32XTf\+4NGm1YJKzU5zf5wikDFtUAuAm8aIPwvI=
#    - secure: "bdWuTMlcWRCFyDwqu1uFbUkciUQolTMQ/nkx47RuBX3Q8QhGqs8+QZxXbdP/9utn8NHpe6nENucuiSi549Oi6nPp3rSG9DJepGIdvkMiVavP+qdAgwJjonOswaPHGg1XEk0ciWyUdbt+jw13+s8KTsKAq56AVuKPaO1SdArzP6KFweveUxpZD6w+AwkKNVv/WvGobNa/jtWytML2enP4gMUUSA7uiNY5S83FacJiX3uyY9/i1Ks832Owzp2SiLlTcftTdwMQB06WkIDMNzo8ibJ7XA2QmrcLYRw3bRvqkO4+ZX1daoStS2Tsxdbl8qQFUBM9bJT813nY1uco0ckvVex7u/SJKzTmIsYPHWWTrT6J3W4KeN7txFaPRK4CdyQ9xY6AQdQXOwCChvJqhYxNNkT8aM1cJ4hpetBIpHbN+Kzo0FWbD4OBiS2fjNWNyKphqUf/VozttGrEVCnKW184S2vZPYyIT2HP5/ZfoFIGDnpcn+j69OqevHxel9sQtRzAJu5aMmg084KsxToUJurGRCMc4wgJH5nQExpusRG3NMdzsVX1K974HTpetSh3pbd66uBZt7cvkFaINi80OjuLBxhlhqSYGJSBDqymX8olqAd20hh6QO4kfUNaNl1CddXBi+ehDz4e7+Js9G8YNxIVG1yncBzTL+6Fbyt+PlycloE="
#    - secure: "gmlyW49HKfMWCweKsQCfaiNfvt9OrliLdb0ZkXaIMVlyBOWgP/e6rrHWUTVVprykZCJI8Q1qrLiPZ8nFCqJvTZhgIai0rCq/43wc7mvxnurRn1WtpWMt2mUPGv77uip7wotYE9zVPEUUWfyZVNYnQvFGHYXPAt7MSI3cRKWLLDJVN2KaN3M1vnkXg8Xf3rjuWoaKgXSRHqG5NhrvOuUD5pDhZsY2gAiBy+L3WP3jzrSH6fCbYreNDqrm1fgNnFycPdkOL5KSO5Vub3B+Wwq1gJ7kH9uyv9Vgr2wPhyv5rYM5ULm7y3SDOS/9NPGGiJD6Pb9TG6w43dN0j/qfwP4vzoa/7iPu/1nZhNEHsGj5KLEzBs8FcM+zjd4EP5rWPL4JsJxQAkNK2wyovumVxA8HueX+HIzi2AbuxnK0PfMn0AuI4TeTq8XxpT3AqYT2Y+RoKMzvs187VezsI4URCVb3z9zHM+xrITsRcm8wNv6qb7naW5ovfOxTgv49GaW+DdlwQOnCoYOfwvGAX2vw4jGHbdkj8YQkqX1+ef5aBbynwxVVE1jJ85StkxRkCELQ9H2HUWN7TEdoGDhOdbIfEvwooGZ3CDaN0LaWRv18gECWu4AFf7eLTLQ0aoQbROq8v3it1zfNtmx2uQP+gVngAx9JxTX2LIyZQCj6FPmBZaca1PA="

before_install:
  - python --version
  - pip --version
  - uname -a
  - lsb_release -a
  - sudo python -m pip install -U pip
  - python -m pip install tox
  - chmod +x scripts/install_anaconda.sh
  - scripts/install_anaconda.sh
  - export CONDA_EXE=/home/travis/miniconda/bin/conda
  - echo $CONDA_EXE

script:
  - tox -vv

after_success:
  - tox -e report,codecov
  - sudo apt-get install jq
  - curl -LSs "$(curl -LSs https://api.github.com/repos/codacy/codacy-coverage-reporter/releases/latest | jq -r '.assets | map({name, browser_download_url} | select(.name | endswith(".jar"))) | .[0].browser_download_url')" -o codacy-coverage-reporter-assembly.jar
  - java -jar codacy-coverage-reporter-assembly.jar report -l Python -r coverage.xml


jobs:
  include:
#  - stage: Build_n_test
#    python: '3.6'
#    env: TOXENV=clean,py36-cov
#  - stage: Build_n_test
#    python: '3.7'
#    env: TOXENV=clean,py37-cov
#  - stage: Build_n_test
#    python: '3.8'
#    env: TOXENV=clean,py38-cov
#  - stage: Check_distro
#    env: TOXENV=check
#    name: "Check source distribution"
#  - stage Integration-Test
#    name: "Upload package to test-pypi"
#    python: '3.8'
#    script:
#      - export PYPI_USERNAME=$TEST_PYPI_USERNAME
#      - export PYPI_PASSWORD=$TEST_PYPI_PASSWORD
#      - tox -e deploy-pypi
#      - chmod +x scripts/integration-test.sh
#      - scripts/integration-test.sh
#    after_success: skip
  - stage: Staging-Integration-test
    name: "Do an emulated real-world-scenario test using the staging server: install lib from test-pypi and run tests"
    python: '3.8'
    script:
      - export PYPI_USERNAME=$TEST_PYPI_USERNAME
      - export PYPI_PASSWORD=$TEST_PYPI_PASSWORD
      - tox -e deploy-pypi -vv
#      - chmod +x scripts/integration-test.sh
#      - scripts/integration-test.sh
    after_success: skip
##  - stage: Build docs
##    install:
##      - sudo apt-get install python-enchant
##    env: TOXENV=spell,docs
##    name: "Build documentation"
#  - stage: deploy to staging (pypi test server)
#    deploy:
#    - provider: script
#      script: tox -e deploy-pypi -vv
#      on:
#        branch: staging
#    before_install: skip
#    install: skip
#    script: skip
#    after_success: skip


after_failure:
  - more .tox/log/* | cat
  - more .tox/*/log/* | cat


# In this stage ALL jobs have succeeded!
# - echo "Potentially any of (Unittests, integrations tests, functional tests, regression tests, stress tests)."
# - echo "You can use this 'point' to \"send stuff in production\""
#deploy:
#  - provider: script
#    skip_cleanup: true
#    script: assh -p22 $STAGING_SERVER_USER@$STAGING_SERVER "mkdir -p $STAGING_PATH_STABLE" && ssh -p22 $STAGING_SERVER_USER@$STAGING_SERVER "mkdir -p $STAGING_PATH_TRUNK" && rsync -rav -e ssh --exclude='.git/' --exclude=scripts/ --exclude='.travis.yml' --delete-excluded ./ $STAGING_SERVER_USER@$STAGING_SERVER:$STAGING_PATH_TRUNK && rsync -rav -e ssh --exclude='.git/' --exclude=scripts/ --exclude='.travis.yml' --delete-excluded ./ $STAGING_SERVER_USER@$STAGING_SERVER:$STAGING_PATH_STABLE
#    on:
#      branch: staging
#  - provider: script
#    skip_cleanup: true
#    script: ssh -p22 $PRODUCTION_SERVER_USER@$PRODUCTION_SERVER "mkdir -p $PRODUCTION_SERVER_THEMES_PATH/_tmp-bornholm"&& ssh -p22 $PRODUCTION_SERVER_USER@$PRODUCTION_SERVER "mkdir -p $PRODUCTION_SERVER_THEMES_PATH/bornholm" && rsync -rav -e ssh --exclude='.git/' --exclude=scripts/ --exclude='.travis.yml' --delete-excluded ./ $PRODUCTION_SERVER_USER@$PRODUCTION_SERVER:$PRODUCTION_SERVER_THEMES_PATH/_tmp-bornholm && ssh -p22 $PRODUCTION_SERVER_USER@$PRODUCTION_SERVER "mv $PRODUCTION_SERVER_THEMES_PATH/bornholm $PRODUCTION_SERVER_THEMES_PATH/_old-bornholm && mv $PRODUCTION_SERVER_THEMES_PATH/_tmp-bornholm $PRODUCTION_SERVER_THEMES_PATH/bornholm" && ssh -p22 $PRODUCTION_SERVER_USER@$PRODUCTION_SERVER "rm -rf $PRODUCTION_SERVER_THEMES_PATH/_old-bornholm"
#    on:
#      branch: master
#deploy:
#  provider: script
#  script: .travis/deploy.sh
#  on:
#    all_branches: true


#notifications:
#  email:
#    on_success: never
#    on_failure: never


#- stage: release
#    if: tag IS present
#    deploy:
#      provider: pypi
#      user: praekelt.org
#      password:
#      secure: <encrypted password>
#      distributions: sdist bdist_wheel
#      on:
#        tags: true
#
#    install: skip
#    script: skip
#    after_success: skip
